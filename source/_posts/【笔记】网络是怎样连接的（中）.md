---
title: 【笔记】网络是怎样连接的（中）
abbrlink: eb39dc71
date: 2021-12-14 21:18:14
updated: 2021-12-14 21:18:14
description: 你有没有想过，互联网是怎样连接起来的？
index_img: /image/网络是怎样连接的/网络是怎样连接的.jpg
banner_img:  /image/网络是怎样连接的/network.jpg
tags:
  - 基础体系
categories: 笔记
---

## 第三章 从网线到网络设备

### 3.1 信号在网线和集线器中传输

#### 3.1.1 防止信号衰减

- 网卡与集线器使用双绞线链接的示意图

  ![epub_907755_244.jpeg](/image/网络是怎样连接的/e5215096ad40eaf6c54f0fa1139ca38a318a5d1c.jpeg)

- 信号在网线的传输过程中，能量会逐渐损失，网线越长，信号衰减越严重，一方面会导致波形逐渐失真，另一方面也会导致波形拐角部分变圆

- 衰减加上噪声的影响，会使得传输的信号进一步失真，使得接收方可能出现对 0 和 1 的误判，这就是产生通信错误的原因之一

#### 3.1.3 “双绞”抑制噪声

- 双绞线的“双绞”的意思就是以两根信号线为一组缠绕在一起，这种拧麻花一样的设计是为了抑制噪声的影响（不是抑制衰减）

- 噪声产生的原因是网线周围的电磁波，当电磁波接触到金属等导体时，在其中就会产生电流。因此，如果网线周围存在电磁波，就会在网线中产生和原本的信号不同的电流。由于信号本身也是一种带有电压变化的电流，其本质和噪声产生的电流是一样的，所以信号和噪声的电流就会混杂在一起，导致信号的波形发生失真，这就是噪声的影响

- 影响网线的电磁波：

  - 一种是由电机、荧光灯、CRT 显示器等设备泄漏出来的电磁波，这种电磁波来自网线之外的其他设备

  - 另一种电磁波是从网线中相邻的信号线泄漏出来的。由于传输的信号本身就是一种电流，当电流流过时就会向周围发出电磁波，这些电磁波对于其他信号线来说就成了噪声。这种内部产生的噪声称为串扰（crosstalk）

- 双绞线如何抑制两种电磁波：

  ![epub_907755_247.jpeg](/image/网络是怎样连接的/efbd067885e6a33489719c0a198109bba0f425a8.jpeg)

  - 外源性电磁波：通过两根信号线的缠绕抵消外源性噪声。将信号线缠绕在一起，信号线就变成了螺旋形，其中两根信号线中产生的噪声电流方向就会相反，从而使得噪声电流相互抵消，噪声就得到了抑制

  - 内源性电磁波：通过改变节距抑制内源性噪声。要抑制这种噪声，关键在于双绞线的缠绕方式。在一根网线中，每一对信号线的扭绞间隔（节距）都有一定的差异，这使得在某些地方正信号线距离近，另一些地方则是负信号线距离近。由于正负信号线产生的噪声影响是相反的，所以两者就会相互抵消。从网线整体来看，正负的分布保持平衡，自然就会削弱噪声的影响

- 除了双绞方法抑制噪声，还有其他一些工艺也能够帮助提升性能。例如在信号线之间加入隔板保持距离，以及在外面包裹可阻挡电磁波的金属屏蔽网等。根据性能指标不同，网线性能以“类”进行以下区分：

  ![epub_907755_248.jpeg](/image/网络是怎样连接的/0d344472683ea1f642f8d7fb9e19ae0852564cf6.jpeg)

#### 3.1.4 集线器发送信号

- 集线器每个接口的后面装有和网卡中的 PHY（MAU）功能相同的模块，为了正常接收信号，必须将“发送线路”和“接收线路”连接起来才行，也就是需要使用交叉接线的方式

- 集线器的接口中有一个 MDI/MDI-X 切换开关，MDI 就是对 RJ-45 接口和信号收发模块进行直连接线，而 MDI-X 则是交叉接线。

  由于集线器的接口一般都是 MDI-X 模式，要将两台集线器相连时，就需要将其中一台改成 MDI 模式。如果集线器上没有 MDI 切换开关，而且所有的接口又都是 MDI-X 时，可以用交叉网线连接两台集线器。所谓交叉网线，就是一种将发送和接收信号线反过来接的网线

- 同理，也可以使用交叉网线将两台计算机直接连接起来，这是因为因为网卡的 PHY（MAU）模块和集线器都是一样的，所以两台计算机的网卡也可以相互连接，只要将一侧的发送信号线和另一侧的接收信号线连起来就可以收发数据了

  但是实际上现在的网络设备基本都支持“收发调换”功能了，所以直接使用平行线也是可以互联的，例如最常见的“计算机 -- 网线 -- 树莓派”

- 信号到达集线器的 PHY（MAU）模块后，会进入中继电路。中继电路的基本功能就是将输入的信号广播到集线器的所有端口上。当然，也有一些产品具有信号整形、错误抑制等功能，但基本上就是将输入的信号原封不动地输出到网线接口，接下来，信号从所有接口流出，到达连接在集线器上的所有设备

- 由于集线器只是原封不动地将信号广播出去，所以即便信号受到噪声的干扰发生了失真，也会原样发送到目的地。这时，接收信号的设备，也就是交换机、路由器、服务器等，会在将信号转换成数字信息后通过 FCS 校验发现错误，并将出错的包丢弃

### 3.2 交换机的包转发操作

#### 3.2.1 交换机与地址表

- 交换机内部机构：

  ![epub_907755_260.jpeg](/image/网络是怎样连接的/d7872e9f97ec526e8e1f6f996829075ced0138e7.jpeg)

- 交换机收发步骤：

  1. 首先，信号到达网线接口，并由 PHY（MAU）模块进行接收，这一部分和集线器是相同的

  2. 接下来，PHY（MAU）模块会将网线中的信号转换为通用格式，然后传递给 MAC 模块。MAC 模块将信号转换为数字信息，然后通过包末尾的 FCS 校验错误，如果没有问题则存放到缓冲区中，检测到错误则丢弃这个包

     - 这部分操作和网卡基本相同，可以认为交换机每个网线接口后面都有一块网卡，网线接口和后面的电路部分加在一起称为一个端口，也就是说交换机的一个端口就相当于计算机上的一块网卡

     - 换句话说，如果在计算机上安装多块网卡，并开启“混杂模式”让网卡接收所有的网络包，然后再安装一个和交换机具备同样功能的网络包转发软件，那么这台计算机就变成了一台交换机

     - 交换机的工作方式和网卡有一点不同。网卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是发给自己的则丢弃。相对地，交换机的端口不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中

     - 和网卡不同，交换机的端口不具有 MAC 地址，也就是说，交换机端口的 MAC 模块不具有 MAC 地址。但是内置了管理功能的交换机除外，这种交换机相当于集成了计算机和交换机两种设备，其中计算机部分是具有 MAC 地址的

  3. 将包存入缓冲区后，接下来需要查询一下这个包的接收方 MAC 地址是否已经在 MAC 地址表中有记录了

     - MAC 地址表主要包含两个信息，一个是设备的 MAC 地址，另一个是该设备连接在交换机的哪个端口上

  4. 当网络包通过交换电路到达发送端口时，端口中的 MAC 模块和 PHY（MAU）模块会执行发送操作，将信号发送到网线中，这部分和网卡发送信号的过程是一样的

     - 根据以太网的规则，首先应该确认没有其他设备在发送信号，也就是确认信号收发模块中的接收线路没有信号进来。如果检测到其他设备在发送信号，则需要等待信号发送完毕。如果没有其他信号，或者其他信号已经发送完毕，这时就可以将包的数字信息转换为电信号发送出去。在发送信号的过程中，还需要对接收信号进行监控，这一点和网卡也是一样的。如果在发送过程中检测到其他设备发送信号，就意味着出现了信号碰撞，这时需要发送阻塞信号以停止网络中所有的发送操作，等待一段时间后再尝试重新发送，这一步和网卡也是一样的

       这个操作过程的前提是终端通过集线器连接到交换机，也就是半双工模式的工作方式。这是以太网的原型，但现在基本上都不使用集线器了，而是直接用交换机将终端和路由器相连接，在这种情况下，交换机的端口会自动切换为全双工模式。关于全双工模式的细节请查看下一部分

- 交换机在转发包的过程中，还需要对 MAC 地址表的内容进行维护，维护操作分为两种：

  - 第一种是收到包时，将发送方 MAC 地址以及其输入端口的号码写入 MAC 地址表中

  - 另一种是删除地址表中某条记录的操作，这是为了防止设备移动时产生问题

    交换机没办法知道某个设备是否已经从原来的端口移走了。因此地址表中的记录不能永久有效，只需要将一段时间不使用的过时记录从地址表中删除就可以了

- 交换机可同时转发多个包，集线器无法同时传输多路信号，因此从设备整体的转发能力来看，交换机要高于集线器

- 特殊情况一：交换机查询地址表之后发现记录中的目标端口和这个包的源端口是同一个端口

  - 用集线器和交换机连接在一起时就会遇到这样的情况，例如计算机 A 和 B 连接到集线器，集线器连接到交换机

  - 计算机 A 发送的包到达集线器后会被集线器转发到所有端口上，也就是会到达交换机和计算机 B。这时，交换机转发这个包之后，这个包会原路返回集线器，然后，集线器又把包转发到所有端口，于是这个包又到达了计算机 A 和计算机 B。所以计算机 B 就会收到两个相同的包，这会导致无法正常通信

  - 因此，当交换机发现一个包要发回到原端口时，就会直接丢弃这个包

- 特殊情况二：地址表中找不到指定的 MAC 地址

  - 可能是因为具有该地址的设备还没有向交换机发送过包，或者这个设备一段时间没有工作导致地址被从地址表中删除了

  - 这种情况下，交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口上，无论该设备连接在哪个端口上都能收到这个包

- 如果接收方 MAC 地址是一个广播地址，那么交换机会将包发送到除源端口之外的所有端口

  广播地址（broadcast address）是一种特殊的地址，将广播地址设为接收方地址时，包会发送到网络中所有的设备。MAC 地址中的 FF:FF:FF:FF:FF:FF 和 IP 地址中的 255.255.255.255 都是广播地址。

#### 3.2.2 全双工模式

- 全双工模式是交换机特有的工作模式，它可以同时进行发送和接收操作，集线器不具备这样的特性

- 使用集线器时，如果多台计算机同时发送信号，信号就会在集线器内部混杂在一起，进而无法使用，这种现象称为碰撞，是以太网的一个重要特征，只要不用集线器，就不会发生碰撞

  使用双绞线时，发送和接收的信号线是各自独立的，因此在双绞线中信号不会发生碰撞。网线连接的另一端，即交换机端口和网卡的 PHY（MAU）模块以及 MAC 模块，其内部发送和接收电路也是各自独立的，信号也不会发生碰撞。因此，只要不用集线器，就可以避免信号碰撞了

- 全双工模式：以太网规范中规定了在网络中有信号时要等该信号结束后再发送信号，因此发送和接收还是无法同时进行（半双工模式）。人们对以太网规范进行了修订，增加了一个无论网络中有没有信号都可以发送信号的工作模式，同时规定在这一工作模式下停用碰撞检测。在全双工模式下，无需等待其他信号结束就可以发送信号，因此它比半双工模式速度要。由于双方可以同时发送数据，所以可同时传输的数据量也更大，性能也就更高。

- 全双工模式的工作方式：在 MAU 的发送和接收电路之间有一个检测信号碰撞的模块，当网络在全双工模式下工作时，发送和接收可同时进行，这一模块就失效了

  ![epub_907755_270.jpeg](/image/网络是怎样连接的/ae4ec9e6954b5b0f6e263a27c8bdcd52e000eac4.jpeg)

- 单工、半双工、全双工：

  - 单工：指数据传输只支持数据在一个方向上传输

  - 半双工：若使用同一根传输线既作接收又作发送，虽然数据可以在两个方向上传送，但通信双方不能同时收发数据，这样的传送方式就是半双工制。采用半双工方式时，通信系统每一端的发送器和接收器，通过收/发开关转接到通信线上，进行方向的切换，因此，会产生时间延迟。收/发开关实际上是由软件控制的电子开关

  - 全双工：当数据的发送和接收分流，分别由两根不同的传输线传送时，通信双方都能在同一时刻进行发送和接收操作，这样的传送方式就是全双工制。在全双工方式下，通信系统的每一端都设置了发送器和接收器，因此，能控制数据同时在两个方向上传送。全双工方式无需进行方向的切换，因此，没有切换操作所产生的时间延迟，这对那些不能有时间延误的交互式应用 (例如远程监测和控制系统) 十分有利。这种方式要求通讯双方均有发送器和接收器，同时，需要 2 根数据线传送数据信号。(可能还需要控制线和状态线，以及地线)

- 交换机的全双工是指交换机在发送数据的同时也能够接收数据，两者同步进行

- 问题：如果设备 A 和 B 通过交换机同时向设备 C 发送信号会怎样？

  猜测：交换机某一时刻只转发其中一个设备的信号，缓存另外一个设备的信号，不然就导致信号碰撞了

#### 3.2.3 自动协商

- 自动协商：指的是设备自动切换工作模式的功能，这一功能可以由相互连接的双方探测对方是否支持全双工模式，并自动切换成相应的工作模式。此外，除了能自动切换工作模式之外，还能探测对方的传输速率并进行自动切换

- 在以太网中，当没有数据在传输时，网络中会填充一种被称为连接脉冲的脉冲信号。在没有数据信号时就填充连接脉冲，这使得网络中一直都有一定的信号流过，从而能够检测对方是否在正常工作，或者说网线有没有正常连接。以太网设备的网线接口周围有一个绿色的 LED 指示灯，它表示是否检测到正常的脉冲信号。如果绿灯亮，说明 PHY（MAU）模块以及网线连接正常（无法判断 MAC 模块、缓冲区、内存和总线部分的异常）

- 在双绞线以太网规范最初制定的时候，只规定了按一定间隔发送脉冲信号，这种信号只能用来确认网络是否正常。后来，人们又设计出了如图这样的具有特定排列的脉冲信号，通过这种信号可以将自身的状态告知对方

  ![epub_907755_274.jpeg](/image/网络是怎样连接的/7ace9e49e913a9841ed8bc389e46c768e6295991.jpeg)

- 自动协商功能就利用了这样的脉冲信号，即通过这种信号将自己能够支持的工作模式和传输速率相互告知对方，并从中选择一个最优的组合

### 3.3 路由器的包转发操作

#### 3.3.1 路由器与路由表

- 路由器简略构造：

  ![epub_907755_277.jpeg](/image/网络是怎样连接的/95ab517e2025c1546da3933005cdf16f398facb8.jpeg)

- 路由器包接收步骤：

  1. 首先会通过端口将发过来的包接收进来，这一步的工作过程取决于端口对应的通信技术

  2. 接下来，转发模块会根据接收到的包的 IP 头部中记录的接收方 IP 地址，在路由表中进行查询，以此判断转发目标

  3. 然后，转发模块将包转移到转发目标对应的端口，端口再按照硬件的规则将包发送出去，也就是转发模块委托端口模块将包发送出去的意思

- 路由表：

  - 最左侧的目标地址列记录的是接收方的信息。这里的 IP 地址只包含表示子网的网络号部分的比特值，而表示主机号部分的比特值全部为 0

  - 子网掩码用于判断网络号的比特数

  - 网关和接口表示网络包的转发目标。根据目标地址和子网掩码匹配到某条记录后，路由器就会将网络包交给接口列中指定的网络接口（即端口），并转发到网关列中指定的 IP 地址

  - 最后一列是跃点计数，它表示距离目标 IP 地址的距离是远还是近。这个数字越小，表示距离目的地越近；数字越大，表示距离目的地越远

  ![epub_907755_284.jpeg](/image/网络是怎样连接的/30e583aea615a43f6c4f54ee34e763ee674bcd0b.jpeg)

- 路由器根据“IP 地址”判断转发目标，路由器会将接收到的网络包的接收方 IP 地址与路由表中的目标地址进行比较，并找到相应的记录。交换机在地址表中只匹配完全一致的记录，而路由器则会忽略主机号部分，只匹配网络号部分

- 路由聚合：有时地址本身的子网掩码和路由表中的子网掩码是不一致的，这是路由聚合的结果。路由聚合会将几个子网合并成一个子网，并在路由表中只产生一条记录。相对地，还有另外一些情况，如将一个子网进行细分并注册在路由表中，然后拆分成多条记录

- 从结果上看，路由表的子网掩码列只是用来在匹配目标地址时告诉路由器应该匹配多少个比特。而且，目标地址中的地址和实际子网的网络号可能并不完全相同，但即便如此，路由器依然可以正常工作

- 路由表记录维护的方式和交换机也有所不同。交换机中对 MAC 地址表的维护是包转发操作中的一个步骤，而路由器中对路由表的维护是与包转发操作相互独立的，也就是说，在转发包的过程中不需要对路由表的内容进行维护

- 对路由表的维护方法：

  - 由人手动维护路由记录

  - 根据路由协议机制，通过路由器之间的信息交换由路由器自行维护路由表的记录

- 路由器的端口都具有 MAC 地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃

#### 3.3.2 路由器包转发操作

- 完成包接收操作后，MAC 头部作用完成，路由器会丢弃包开头的 MAC 头部，接下来，路由器会根据 MAC 头部后方的 IP 头部中的内容进行包的转发操作

- 路由器包发送操作：

  1. 首先根据路由最长匹配原则查询路由表判断转发目标：关于匹配路由表的细节请查看下一部分

  2. 更新 IP 头部中的 TTL：关于 TTL 的细节请查看下一部分

  3. 决定是否需要进行分片，如果需要分片，则分片之后还（可能）会重新计算校验和：关于分片细节请查看下一部分

     - 因为和以太网以及通信线路本身的错误校验机制相比，IP 校验和的可靠性很低，因此大多数路由器都不去校验这个值，就当它不存在一样

  4.（进行包发送操作，这一步操作取决于输出端口的类型，这里假设是以太网类型，接下来的步骤就是上一章节所讲述的发送以太网包的步骤了）

     - 如果是以太网端口，则按照以太网的规则将包转换为电信号发送出去

     - 如果是 ADSL 则按照 ADSL 的规则来转换，以此类推。在家庭网络中，路由器后面一般连接 ADSL 等线路接入互联网，因此路由器会根据接入网的规则来发送包

#### 3.3.3 匹配路由

- 在匹配路由表的时候，可能会匹配到多条候选记录，其中，路由器首先寻找网络号比特数最长的一条记录，也就是最长匹配原则

  网络号比特数越长，说明主机号比特数越短，也就意味着该子网内可分配的主机数量越少，即子网中可能存在的主机数量越少，这一规则的目的是尽量缩小范围，所以根据这条记录判断的转发目标就会更加准确

- 有时候路由表中会存在网络号长度相同的多条记录，例如考虑到路由器或网线的故障而设置的备用路由就属于这种情况。这时，需要根据跃点计数的值来进行判断。跃点计数越小说明该路由越近，因此应选择跃点计数较小的记录

- 如果在路由表中无法找到匹配的记录，路由器会丢弃这个包，并通过 ICMP 消息告知发送方

- 路由器对没有匹配到记录的包的处理方式和交换机不同，交换机针对的网络规模最多也就是几千台设备的规模，而路由器的工作规模是整个互联网。若是路由器选择直接转发到整个网络，那么就会产生大量网络包，造成网络拥塞

- 路由表一般有一个特殊的记录，称为默认路由。这一行的子网掩码是 0.0.0.0，这意味着网络包接收方地址和路由表目标地址的配置中需要匹配的比特数为 0，也就是说根本不需要匹配，无论任何地址都能匹配到这一条记录

  只要在这一条记录的网关列中填写接入互联网的路由器地址，当匹配不到其他路由时（由于匹配的比特数越长优先级越高 -- 最长匹配原则，因此子网掩码为 0.0.0.0 的记录优先级是最低的，只有当找不到其他匹配的记录时，才会选择这条记录），网络包就会被转发到互联网接入路由器。因此这条记录被称为默认路由，这一行配置的网关地址被称为默认网关

- 路由器判断下一个转发目标的方法如下

  - 如果路由表的网关列内容为 IP 地址，则该地址就是下一个转发目标

  - 如果路由表的网关列内容为空，则 IP 头部中的接收方 IP 地址就是下一个转发目标。

#### 3.3.4 包的有效期

- 在转发之前，路由器还会对网络包进行一些准备工作，第一个工作是更新 IP 头部中的 TTL（Time to Live，生存时间）字段

- TTL 字段表示包的有效期，包每经过一个路由器的转发，这个值就会减 1，当这个值变成 0 时，就表示超过了有效期，这个包就会被丢弃

- TTL 机制是为了防止包在一个地方陷入死循环。如果路由表中的转发目标都配置正确，应该不会出现这样的情况，但如果其中的信息有问题，或者由于设备故障等原因切换到备用路由时导致暂时性的路由混乱，就会出现这样的情况

- 发送方在发送包时一般会将 TTL 设为 64 或 128，现在的互联网即便访问一台位于地球另一侧的服务器，最多也只需要经过几十个路由器，因此只要包被正确转发，就可以在过期之前到达目的地

#### 3.3.5 分片功能

- 路由器的端口并不只有以太网一种，也可以支持其他局域网或专线通信技术。不同的线路和局域网类型各自能传输的最大包长度也不同，因此输出端口的最大包长度可能会小于输入端口。即便两个端口的最大包长度相同，也可能会因为添加了一些头部数据而导致包的实际长度发生变化，ADSL、FTTH 等宽带接入技术中使用的 PPPoE 协议就属于这种情况。无论哪种情况，一旦转发的包长度超过了输出端口能传输的最大长度，就无法直接发送这个包了

- 遇到这种情况，可以使用 IP 协议中定义的分片功能对包进行拆分，缩短每个包的长度

- IP 的分片功能和 TCP 拆分数据的机制本质上是不同：TCP 拆分数据的操作是在将数据装到包里之前进行的，换句话说，拆分好的一个数据块正好装进一个包里。从 IP 分片的角度来看，这样一个包其实是一个未拆分的整体，也就是说，分片是对一个完整的包再进行拆分的过程

- 分片操作步骤：

  1. 首先确定输出端口的 MTU，看看这个包能不能不分片直接发送，在此之前还需要看一下 IP 头部中的标志字段，确认是否可以分片

     - 最大包长度是由端口类型决定的，用这个最大长度减掉头部的长度就是 MTU，将 MTU 与要转发的包长度进行比较

  2. 对数据进行拆分，这里的数据实际上就是指源网络包中的数据（TCP 头部、UDP 头部都是被视为数据的）

  3. 数据被拆分后，每一份数据前面会加上 IP 头部，其大部分内容都和原本的 IP 头部一模一样，但其中有部分字段需要更新，这些字段用于记录分片相关的信息

- 已分片后的包不允许再分片

- 如果查询标志字段发现不能分片，那么就只能丢弃这个包，并通过 ICMP 消息通知发送方。否则，就可以按照输出端口 MTU 对数据进行依次拆分了

#### 3.3.6 路由器和交换机的关系

- 路由器是基于 IP 设计的，而交换机是基于以太网设计的，因此 IP 与以太网的关系也就是路由器与交换机的关系。换句话说，路由器将包的传输工作委托给交换机来进行（这里讲的内容只适用于原原本本实现 IP 和以太网机制的纯粹的路由器和交换机，实际的路由器有内置交换机功能的，比如用于连接互联网的家用路由器就属于这一种，对于这种路由器，上面内容可能就不适用了）

- 从包的转发目标也可以看出路由器和交换机之间的委托关系。IP 并不是委托以太网将包传输到最终目的地，而是传输到下一个路由器。在创建 MAC 头部时，也是从 IP 的路由表中查找出下一个路由器的 IP 地址，并通过 ARP 查询出 MAC 地址，然后将 MAC 地址写入 MAC 头部中的，这表示 IP 对以太网的委托只是将包传输到下一个路由器就行了

- 简单来说，IP（路由器）负责将包发送给通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的

- 对于其他的网络，例如无线局域网，它们和 IP 的关系也与上面类似。也就是说，如果和下一个路由器之间是通过无线局域网连接的，那么就委托无线局域网将包传输过去；如果是通过互联网线路连接的，那么就委托它将包传输过去

- IP 本身不负责包的传输，而是委托各种通信技术将包传输到下一个路由器，这样的设计是有重要意义的，即可以根据需要灵活运用各种通信技术，这也是 IP 的最大特点

### 3.4 路由器的附加功能

#### 3.4.1 地址转换和包过滤

- 内网中可用做私有地址的仅限以下部分地址：

  - A 类：10.0.0.0~10.255.255.255，即 10.0.0.0/8

  - B 类：172.16.0.0~172.31.255.255，即 172.16.0.0/12

  - C 类：192.168.0.0~192.168.255.255，即 192.168.0.0/16

  - 实际上根据规范定义，还有很多其他的内网网段（IPv6），例如 0.0.0.0/8、100.64.0.0/10、127.0.0.0/8 等等

- 地址转换的基本原理是在转发网络包时对 IP 头部中的 IP 地址和端口号进行改写

- 发送方的包发送到网络的时候，地址转换设备会叫发送方的地址从私有地址修改为公有地址，这里使用的公有地址是地址转换设备的互联网接入端口的地址。与此同时，端口号也需要进行改写，地址转换设备会随机选择一个空闲的端口

  然后，改写前的私有地址和端口号，以及改写后的公有地址和端口号，会作为一组相对应的记录保存在地址转换设备内部的一张表中。

- 具备地址转换功能的设备不仅有路由器，有些防火墙也有地址转换功能，它的工作方式和路由器是相同的

- 在对外只能使用一个公有地址的情况下，可以用不同的端口号来区别内网中的不同终端

- 改写发送方 IP 地址和端口号之后，包就被发往互联网，最终到达服务器，然后服务器会返回一个包。服务器返回的包的接收包是原始包的发送方，因此返回的包的接收方就是改写后的公有地址和端口号。这个公有地址其实是地址转换设备的地址，因此这个返回包就会到达地址转换设备

  接下来，地址转换设备会从地址对应表中通过公有地址和端口号找到相对应的私有地址和端口号，并改写接收方信息，然后将包发给公司内网，这样包就能够到达原始的发送方了

- 在包的收发过程中，地址转换设备需要根据对应表查找私有地址和公有地址的对应关系，再改写地址和端口号之后进行转发

  当数据收发结束，进入断开阶段，访问互联网的操作全部完成后，对应表中的记录就会被删除

- 改写端口的目的是提高公有地址利用率

- 开启地址转换之后，对于没有在访问互联网的内网设备，是无法从互联网向其发送网络包的。而且即便是正在访问的设备，也只能向和互联网通信中使用的那个端口发送网络包，无法向其他端口发送包。也就是说，除非公司主动允许，否则是无法从互联网向公司内网发送网络包的。这种机制具有防止非法入侵的效果

- 如果希望能从互联网访问公司内网，这需要往路由器手动添加地址转换关系。只要事先将地址和端口的关联信息添加到地址转换设备的对应表中，就可以从互联网访问内网中的设备了

- 包过滤就是在对包进行转发时，根据 MAC 头部、IP 头部、TCP 头部的内容，按照事先设置好的规则决定是转发这个包，还是丢弃这个包。我们通常说的防火墙设备或软件，大多数都是利用这一机制来防止非法入侵的


## 第四章 通过接入网进入互联网外部

### 4.1 ADSL 接入网的结构和工作方式

#### 4.1.1 互联网的结构

- 互联网的结构和家庭、公司网络的结构基本相同，也是通过路由器来转发包的，而且路由器的基本结构和工作方式也没什么不同

- 互联网和家庭、网络结构不同点：

  - 转发设备间的距离有所区别，家庭网络（以太网）距离数量级是几十米到百米，而互联网的距离数量级远大于这个，以太网网线无法支持这样长的距离

  - 路由器在如何控制包的转发目标上也有所区别，也就是路由表记录的维护方式不同。互联网中的路由器上有超过 10 万条路由记录，而且这些记录还在不断变化，当出现线路故障时，或者新的公司加入互联网时，都会引发路由的变化。人工维护这些路由信息是不现实的，必须实现自动化。公司的路由器也有自动维护路由表的机制，但出于各种原因，互联网中采用的机制和公司有所区别

#### 4.1.2 接入网

- 路由器的转发操作都是相同的，因此互联网接入路由器的包转发操作也和第三章讲过的以太网路由器几乎是一样的。

  不过，互联网接入路由器发送网络包的操作和以太网路由器有一点不同，互联网接入路由器是按照接入网规则来发送包的

- 所谓接入网，就是指连接互联网与家庭、公司网络的通信线路。一般家用的接入网方式包括 ADSL、FTTH、CATV、电话线、ISDN 等，公司则还可能使用专线

- 接入网这个词表示的是通信线路的用法，而并不表示通信线路的结构。例如公司里使用的专线，当它用来连接互联网时就叫作接入网，而用来连接总公司和分公司时就不叫接入网。此外，接入网这个词也不仅限于互联网，当使用运营商提供的通信服务时，一般都会将用户与运营商之间的线路叫作接入网。

- ADSL：Asymmetric Digital Subscriber Line，不对称数字用户线。它是一种利用架设在电线杆上的金属电话线来进行高速通信的技术，它的上行方向（用户到互联网）和下行方向（互联网到用户）的通信速率是不对称的。

- FTTH：Fiber To The Home，光纤到户。指的是将光纤接入家庭的意思。

#### 4.1.3 ADSL

- ADSL 接入网结构（PPPoE 方式）：用户端路由器发出的网络包通过 ADSL Modem 和电话线到达电话局，然后到达 ADSL 的网络运营商（即 ISP，互联网服务提供商）

- ADSL Moderm 中文名全称是“调制解调节器”，也就是俗称的“猫”。现在家庭主要是使用路由型 ADSL Moderm，也就是集成了互联网接入路由器和 ADSL Modem 的多功能 ADSL Modem，其实就是把路由器和 ADSL Modem 装到一个外壳里而已

- ADSL Modem 作用是将包拆分成信元，并转换成电信号发送给分离器

- 网络包从用户传输到运营商的过程中，网络包会改变多次形态，主要过程如下：

- 网络包形态变换步骤

  1. 首先，客户端生成的网络包（图中的①和②）先经过集线器和交换机到达互联网接入路由器（图中③），并在此从以太网包中取出 IP 包并判断转发目标（图④），该过程和第三章介绍的以太网路由器工作方式一样

  2. 接下来，包发送的操作也很类似。如果互联网接入路由器和 ADSL Modem 之间是通过以太网连接的，那么就会按照以太网的规则执行包发送的操作，发送信号本身的过程跟之前是一样的，但以太网的头部会有一些差异：

     - 以太网头部差异的具体情况各运营商会有所不同，而且还与 BAS 有关：相关细节请查看下一部分

     - 简单来说，（PPPoE 方式下）在图⑤这一步中网络包会加上 MAC 头部、PPPoE 头部、PPP 头部总共 3 种头部，然后按照以太网规则转换成电信号后被发送出去

     - BAS：Broadband Access Server，宽带接入服务器。它也是一种路由器

     - PPP：Point-to-Point Protocol，点到点协议。它是电话线、ISDN 等通信线路所使用的一种协议，集成了用户认证、配置下发、数据压缩、加密等各种功能

  3. 互联网接入路由器将包发送出去之后，包就到达了 ADSL Modem（图⑥），然后，ADSL Modem 会把包拆分成很多小格子（图⑦），每一个小格子称为一个信元：

     - 信元是一个非常小的数据块，开头是有 5 个字节的头部，后面是 48 个字节的数据，用于一种叫作 ATM 通信技术。可以将信元理解为一种更小一号的包，原理上跟 TCP/IP 将应用程序的数据拆分成块装进一个个包的过程是一样的

     - ATM：Asynchronous Transfer Mode，异步传输。它是在以电话线为载体的传统电话技术基础上扩展出来的一种通信方式。它的数据传输是以“信元”为单位来进行的，这和以包为单位传输数据的 TCP/IP 很像，但这种方式并不适用于计算机通信

     - 之所以要将包拆分成信元，是因为当初开发 ADSL 技术时，通信业比较看好 ATM 技术，各运营商也在 ATM 相关的设备上投入了很多资金。在这样的情况下，如果使用信元来传输数据，就比较容易和其他设备进行整合，可以降低开发投入和设备投入。如果不是出于这样的原因，其实并不需要将包拆分成信元，实际上也有一些 ADSL 运营商使用的 ADSL Modem 是不进行数据拆分的

  4. 将网络包拆分成信元之后，接下来就要将这些信元转换成信号了（图⑧）:

     - 以太网采用的是用方波信号表示 0 和 1 的方式，这种方式很简单，但同样是将数字信息转换成模拟信号，ADSL 采用的方法要复杂一些。其中有两个原因，一个原因是方波信号的波形容易失真，随着距离的延长错误率也会提高；另一个原因是方波信号覆盖了从低频到高频的宽广频段，信号频率越高，辐射出来的电磁噪声就越强，因此信号频谱太宽就难以控制噪声

     - ADSL Modem 采用了一种用圆滑波形（正弦波）对信号进行合成来表示 0 和 1 的技术，这种技术称为调制。调制有很多方式，ADSL 采用的调制方式是振幅调制（ASK）和相位调制（PSK）相结合的正交振幅调制（QAM，也叫正交调幅）方式

  5. ADSL Modem 将信元转换为电信号之后，信号会进入一个叫作分离器的设备，然后 ADSL 信号会和电话的语音信号混合起来一起从电话线传输出去：

     - 在信号从用户端发送出去时，电话和 ADSL 信号只是同时流到一条线路上而已，分离器实际上并没有做什么事

  6. 从分离器出来，就是插电话线的接口，信号从这里出来之后，会通过室内电话线，然后到达大楼的 IDF 和 MDF，外面的电话线在这里和大楼内部的室内电话线相连接

     - 如果是独栋住宅，就可以将室外线和室内线直接连起来

     - IDF：Intermediate Distribution Frame，中间配线盘

     - MDF：Main Distribution Frame，主配线盘（总配线架）

  7. 通过配线盘之后，信号会到达保安器。保安器是为了防止雷电等情况下电话线中产生过大电流的一种保护装置，内部有保险丝

  8. 接下来，信号会进入电线杆上架设的电话电缆

     - 电话线是一种直径 0.32～0.9 mm 的金属信号线，电话线结构如下图：

     - 电话电缆在用户住宅附近一般是架设在电线杆上，但中途会沿电线杆侧面的金属管进入地下。在电话局附近，电话线都是埋在地下的。由于电话局附近的地下电缆很多，集中埋设电缆的地方就形成了一条地道，这部分称为电缆隧道。通过电缆隧道进入电话局后，电缆会逐根连接到电话局的 MDF 上

  9. 信号通过电话线到达电话局之后，会经过配线盘、分离器到达 DSLAM，在这里，电信号会被还原成数字信息——信元（图⑩）

     - DSLAM：DSL Access Multiplexer，数字用户线接入复用设备。它是一种电话局用的多路 ADSL Modem，可以理解为将多个 ADSL Modem 整合在一个外壳里的设备

  10. 信元从 DSLAM 出来之后，会到达一个叫作 BAS 的包转发设备（图⑪），BAS 将接收到的 ATM 信元还原成原始的包

  11. BAS 接收工作完成后，BAS 会将收到的包前面的 MAC 头部和 PPPoE 头部丢弃，取出 PPP 头部以及后面的数据（图⑬）

      - MAC 头部和 PPPoE 头部的作用是将包送达 BAS 的接口，当接口完成接收工作后，它们就完成了使命，可以被丢弃了

  12. 接下来，BAS 会在包的前面加上隧道专用头部，并发送到隧道的出口（图⑭）：关于隧道细节请查看下一部分

      - 一般情况下使用的隧道技术为 L2TP，在这种情况下就会加上 L2TP 头部

  13. 然后，网络包会到达隧道出口的隧道专用路由器（图⑮），在这里隧道头部会被去掉，IP 包会被取出（图 ⑯），并被转发到互联网内部（图⑰）

#### 4.1.4 ADSL 调制信号

- 振幅调制是用信号的强弱，也就是信号振幅的大小来对应 0 和 1 的方式

- 振幅调制另外一个组成元素是相位调制，这是一种根据信号的相位来对应 0 和 1 的方式

- 振幅调制示例：

  - 如下图（b）所示，振幅小的信号为 0，振幅大的信号为 1，这是一种最简单的对应关系。在这个例子中，振幅大小只有两个级别，如果增加振幅变化的级别，就可以对应更多的比特。例如，如果将振幅增加到 4 个级别，则振幅从小到大可分别对应 00、01、10 和 11，这样就可以表示两个比特了。这样做可以将单位时间内传输的数据量加倍，也就能够提高速率。以此类推，如果振幅有 8 个级别，就可以表示 3 个比特，16 个级别就可以表示 4 个比特，速率也就越来越高。不过，信号会在传输过程中发生衰减，也会受到噪声影响而失真，如果振幅级别太多，接收方对信号的识别就容易出错，因此振幅级别也不能太多

  - 下图（c）所示，正相位为 0，反相位为 1，和振幅调制一样，相位调制也可以通过将角度划分为更细的级别来增加对应的比特数量，从而提高速率。但是，角度太接近的时候也容易产生误判，因此这样提升速率还是有限度的

  - ADSL 使用的正交振幅调制就是将前面这两种方式组合起来实现的，如图（d）所示。如果信号的振幅可以表示 1 个比特，相位可以表示 1 个比特，那么加起来就可以表示 2 个比特。因此，将两种方式组合起来，正交振幅调制就可以用一个波表示更多的比特，从而提高传输速率

- 正交振幅调制中，通过增加振幅和相位的级别，就可以增加能表示的比特数。例如，如果振幅和相位各自都有 4 个级别，那么组合起来就有 16 个级别，也就可以表示 4 个比特的值。当然，和单独使用振幅调制或相位调制的情况一样，级别过多就容易发生误判，因此这种方法提升的速率是有限度的

#### 4.1.5 ADSL 多个波合成

- 实际上信号传输的时候不一定要限制在一个频率。不同频率的波可以合成，也可以用滤波器从合成的波中分离出某个特定频率的波，这样一来，能够表示的比特数就可以成倍提高了

- ADSL 使用间隔为 4.3125 kHz 的上百个不同频率的波进行合成，每个波都采用正交振幅调制，而且，根据噪声等条件的不同，每个波表示的比特数是可变的。也就是说，噪声小的频段可以给波分配更多的比特，噪声大的频段则给波分配较少的比特，每个频段表示的比特数加起来，就决定了整体的传输速率

  ADSL 技术中，上行方向（用户到互联网）和下行方向（互联网到用户）的传输速率是不同的，原因也在这里。如果上行使用 26 个频段，下行则可以使用 95 个或者 223 个频段，波的数量不同，导致了上下行速率不同

  当然，下行使用的频段较高，这些信号容易衰减而且更容易受到噪声的影响，因此这些频段可能只能表示较少的比特数，或者干脆无法传输信号。距离越远，频率越高，这种情况也就越显著，因此如果你家距离电话局太远，速率就会下降

- 噪声和衰减等影响线路质量的因素在每条线路上都不同，而且会随着时间发生变化。因此，ADSL 会持续检查线路质量，动态判断使用的频段数量，以及每个频段分配到的比特数。具体来说，当 Modem 通电后，会发送测试信号，并根据信号的接收情况判断使用的频段数量和每个频段的比特数，这个过程称为训练（握手），需要几秒到几十秒的时间

#### 4.1.6 分离器

- 分离器作用：

- 分离器的作用其实在相反的方向，也就是信号从电话线传入的时候。这时，分离器需要负责将电话和 ADSL 的信号进行分离

- 具体来说，分离器的功能是将一定频率以上的信号过滤掉，也就是过滤掉了 ADSL 使用的高频信号，这样一来，只有电话信号才会传入电话机，但对于另一头的 ADSL Modem，则是传输原本的混合信号给它。ADSL Modem 内部已经具备将 ADSL 频率外的信号过滤掉的功能，因此不需要在分离器进行过滤

- 电话局端也有分离器，作用相同

- 分离器还可以防止电话对 ADSL 产生干扰，如果没有分离器，拿起电话听筒接通电话的状态，和放下听筒挂断电话的状态下，信号的传输方式是不同的。当放下听筒时，电话机的电路和电话线是断开的，当拿起听筒时电话机就和电话线相连，电话机的信号就会传到电话线上。这两种状态的差异会导致噪声等线路状态的改变，如果 ADSL 通信过程中拿起话筒导致线路状态改变，就需要重新训练（握手），这就会导致几十秒的通信中断，分离器可以防止发生这样的问题

  当然，也有一种技术能够快速重新握手，即便没有分离器也不会影响 ADSL 通信，G.992.2 的 ADSL 规格就包含这种技术，但 ADSL 信号还是会影响电话，因此 G.992.2 的 ADSL 规格中一般还是需要使用分离器

#### 4.1.7 噪声的干扰

- 电话线和以太网双绞线都是用金属信号线传输电信号，也就是说，电话线也会受到来自外部的噪声和来自内部的噪声（串扰）的干扰，导致信号失真。此外，电话线原本的设计并没有考虑到传输 ADSL 这样的高频信号，从这个角度上可以说它比以太网双绞线更容易受到噪声的干扰

- 电话线受到干扰的方式和双绞线有些不同：

  - 双绞线中只有一路方波信号，信号失真后就无法读取还原成数字信号，于是就会产生错误，但 ADSL 信号受到干扰后并不会立即造成错误

  - ADSL 信号分布在多个频段上，只有和噪声频率相同的信号会受到影响而无法读取，即可用的信号数量减少，结果导致速率下降

- 电话线架设在噪声比较多的地方时，可能就会导致速率下降，比如电车线路旁边，此外，ADSL 还会受到 AM 电台广播的干扰

- 电缆内部产生的噪声也会形成干扰。四芯线的电话缆内部，或者相邻子单元的附近如果同时存在 ADSL 和 ISDN 信号线，ISDN 发出的噪声就会干扰 ADSL

  ADSL 刚刚开始普及的时候，大家还都比较关注防止 ISDN 干扰的技术，不过现在防止 ISDN 干扰的技术已经形成了，因此在使用 ADSL 时已经基本上没必要在意 ISDN 线路的问题了

#### 4.1.8 DSLAM 与 BAS

- DSLAM 通过读取信号波形，根据振幅和相位判断对应的比特值，将信号还原成数字信息，这一过程和用户端的 ADSL Modem 在接收数据时的过程是一样的

- DSLAM，它相当于很多个 ADSL Modem 的功能集中在一个外壳里的设备，方便减少空间占用和整体监控

- DSLAM 和用户端 ADSL Modem 相比还是有一个不同的地方。用户端 ADSLModem 具备以太网接口，可以与用户端的路由器和计算机交互，收发以太网包，而 DSLAM 一般不用以太网接口，而是用 ATM 接口，和后方路由器收发数据时使用的是原始网络包拆分后的 ATM 信元形式

- 也有一些 DSLAM 是不将网络包拆分成 ATM 信元的，而是直接以网络包的状态转换成 ADSL 信号，这样的 DSLAM 在和后方路由器收发数据时也是使用包的形式

- DSLAM 具有 ATM 接口，和后方路由器收发数据时使用的是原始网络包拆分后的 ATM 信元形式

- BAS 和 DSLAM 一样，都具有 ATM 接口，可以接收 ATM 信元，还可以将接收到的 ATM 信元还原成原始的包

- BAS 负责将 ATM 信元还原成网络包并转发到互联网内部

### 4.2 光纤接入网（FTTH）

#### 4.2.1 光纤基本知识

- FTTH 是一种基于光纤的接入网技术，关键在于对光纤的使用

- 光纤的结构如下图所示，它是由一种双层结构的纤维状透明材质（玻璃和塑料）构成的，通过在里面的纤芯中传导光信号来传输数字信息：

- 光纤的通信原理如下，ADSL 信号是由多个频段的信号组成的，比较复杂，但光信号却非常简单，亮表示 1，暗表示 0：

- 数字信息会先转换为电信号，再将电信号转换为光信号

- 发射端将电信号输入 LED、激光二极管等光源，例如高电压发光亮，低电压发光暗，光信号在光纤中传导到达接收端，接收端有可以感应光线的光敏元件，光敏元件可以根据光的亮度产生不同的电压。当光信号照射到上面时，光亮的时候就产生高电压，光暗的时候就产生低电压，这样就将光信号转换成了电信号。最后再将电信号转换成数字信息，我们就接收到数据了

#### 4.2.2 单模和多模

- 光在透明材质中的传导是非常复杂的，不同材质的光纤其透光率和折射率也不同，纤芯的直径等因素也会影响光的传导，其中，纤芯的直径对光的传导影响很大

- 光在光纤中的传导简略解析：

  - 光源在所有方向上都会发光，因此会有各种角度的光线进入纤芯，但入射角度太大的光线会在纤芯和包层（纤芯外沿部分）的边界上折射出去，只有入射角较小的光线会被包层全反射，从而在纤芯中前进

  - 不是所有入射角小的光线都会在纤芯中传导。光也是一种波，因此光也有相位，当光线在纤芯和包层的边界上反射时，会由于反射角产生相位变化。当朝反射面前进的光线和被反射回来的光线交会时，如果两条光线的相位不一致，就会彼此发生干涉抵消，只有那些相位一致的光线才会继续在光纤中传导

  - 光在被纤芯和包层的边界反射时，相位会发生变化。这个变化的量随光在反射面的反射角度不同而不同，大多数角度下，都会因为相位不同而被干涉抵消。不过，有几个特定的角度下，向反射面前进的光和反射回来的光的相位是一致的，只有以这些角度反射的光才能继续向前传导

  - 进入光纤的光线有各种角度，但其中，只有少数按照特定角度入射以保持相位一致的光线才会继续传导。这个角度非常关键，纤芯的直径也是根据这个角度来确定的，而且纤芯的直径大小会极大地改变光纤的性质

- 根据纤芯直径，光纤可以划分成几种类型，大体上包括较细的单模光纤（8～10 μm）和较粗的多模光纤（50 μm 或 62.5 μm），单模和多模实际上表示相位一致的角度有一个还是多个

  - 单模光纤的纤芯很细，只有入射角很小的光线才能进入，因此在能够保持相位一致的角度中，只有角度最小的光线能进入光纤。反过来可以说，单模光纤的纤芯直径就是按照只允许相位一致的最小角度的光进入而设计的

  - 多模光纤的纤芯比较粗，入射角比较大的光也可以进入，这样一来，在相位一致的角度中，不仅角度最小的可以在光纤中传导，其他角度更大一些的也可以，也就是说，可以有多条光线在纤芯中同时传导

- 单模光纤和多模光纤在光的传导方式上有所不同，这决定了它们的特性也有所不同

  - 多模光纤中可以传导多条光线，这意味着能通过的光线较多，对光源和光敏元件的性能要求也就较低，从而可以降低光源和光敏元件的价格

  - 单模光纤的纤芯中只能传导一条光线，能通过的光线较少，相应地对于光源和光敏元件的性能要求就较高，但信号的失真会比较小

- 信号失真与光在纤芯传导时反射的次数相关。

  多模光纤中，多条反射角不同的光线同时传导，其中反射角越大的光线反射次数越多，走过的距离也就越长；相对地，反射角越小的光线走过的距离越短。光通过的距离会影响其到达接收端的时间，也就是说，通过的距离越长，到达接收端的时间越长。结果，多条光线到达的时间不同，信号的宽度就会被拉伸，这就造成了失真。因此，光纤越长，失真越大，当超过允许范围时，通信就会出错。

  相对地，单模光纤则不会出现这样的问题。因为在纤芯传导的光线只有一条，不会因为行进距离的差异产生时间差，所以即便光纤很长，也不会产生严重的失真

- 光纤的最大长度也是由上述性质决定的。单模光纤的失真小，可以比多模光纤更长，因此多模光纤主要用于一座建筑物里面的连接，单模光纤则用于距离较远的建筑物之间的连接。FTTH 属于后者，因此主要使用单模光纤

#### 4.2.3 光纤分路

- 用光纤来代替 ADSL 将用户端接入路由器和运营商的 BAS 连接起来的接入方式就是 FTTH，FTTH 和 ADSL 一样也有不同的衍生规格，主流规格是和 ADSL 一样采用 PPPoE 方式进行接入，后面我们的介绍也是基于 PPPoE 方式。

- FTTH 从形态上说主要有两种类型，这两种方式只是光信号的传输方式有一些区别，实际传输的网络包是相同的，当使用 PPPoE 来传输包时，其工作过程和 ADSL 类似：

  - 一种是用一根光纤直接从用户端连接到最近的电话局，直连方式

  - 另一种光纤的接入方式是在用户附近的电线杆上安装一个名为分光器的设备，通过这个设备让光纤分路，同时连接多个用户，分路方式

- FTTH 接入网的结构：

- 在直连方式的 FFTH 中，用户和电话局之间通过光纤直接连接，网络包的传输方式如下：

  1. 首先，用户端的光纤收发器（将以太网的电信号转换成光信号的设备，也叫终端盒）将以太网的电信号转换成光信号

     - 这一步只进行电信号到光信号的转换，而不会像 ADSL 一样还需要将包拆分成信元，大家可以认为是将以太网包原原本本地转换成了光信号

  2. 接下来，光信号通过连接到光纤收发器的光纤直接到达 BAS 前面的多路光纤收发器

  3. 然后，多路光纤收发器将光信号转换成电信号，BAS 的端口接收之后，将包转发到互联网内部

  4. 把网络包发送到互联网之后，服务器会收到响应，响应包的光信号也是沿着同一条光纤传输到用户端的

     - 前往互联网的上行光信号和前往用户的下行光信号在光纤中混合在一起，信号会变得无法识别，因此需要对它们进行区分，办法是上行和下行信号采用不同波长的光

     - 波长不同的光混合后可通过棱镜原理进行分离，因此光纤中的上行和下行信号即便混合起来也可以识别

     - 在一条光纤中使用不同的波长传输多个光信号的方式叫作波分复用

- 在分路方式的 FFTH 中：

  - 通过光纤分路连接多个用户的光纤接入模式统称为 PON（Passive Optical Network，无源光网络），可分为 GE-PON、WDM-PON、B-PON、G-PON 等多种方式，现在大多使用最高速率为 1 Gbit/s 的 GE-PON 方式

  - 用户端不使用光纤收发器，而是使用一个叫作 ONU 的设备，它将以太网的电信号转换成光信号之后，会到达 BAS 前面的一个叫作 OLT

    - ONU：Optical Network Unit，光网络单元。它和光纤收发器一样，可以将电信号转换成光信号，除此之外还具有和电话局的 OLT 相互配合避免信号碰撞的功能。这个设备有时也被叫作终端盒，因此终端盒这个词本身是对光纤收发器和 ONU 等光纤终端设备的统称

    - OLT：Optical Line Terminal，光线路终端。

  - 光信号的传导方式和刚才介绍的直连方式是一样的，但有一点不同，因为多个用户同时收发网络包时信号会在分光器产生碰撞。因此，OLT 和 ONU 中具备通过调整信号收发时机来避免碰撞的功能。具体来说，OLT 会调整信号发送时机并向 ONU 下发指令，ONU 则根据 OLT 的指令来发送数据

  - 当 BAS 端向用户发送数据时，分光器只需要将信号发给所有用户就可以了，这里并不会发生碰撞，但这样做会导致一个用户收到其他所有用户的信号，造成信息泄露的问题，因此需要在每个包前面加上用于识别 ONU 的信息，当 ONU 收到信号后，会接收发给自己的信号并将其转换成以太网信号

### 4.3 接入网中使用的 PPP 和隧道

#### 4.3.1 用户认证和配置下发

- BAS 是一种进化型的路由器，它具有用户认证和配置下发功能

- ADSL 和 FTTH 接入网中，都需要先输入用户名和密码（也就是俗称的宽带账号），登录之后才能访问互联网，而 BAS 就是登录操作的窗口。BAS 使用 PPPoE 方式来实现这个功能

  - PPPoE：Point-to-Point Protocol over Ethernet，以太网的点对点协议。

  - 也有一些运营商使用 PPPoA 方式实现登录功能

- PPPoE 是由传统电话拨号上网上使用的 PPP 协议发展而来的

#### 4.3.2 PPP 拨号

- PPP 拨号链接操作

  ![epub_907755_375.jpeg](/image/网络是怎样连接的/65dce8eb78041f2e6bf7aab98c9ea0f8c292b843.jpeg)

- 在使用电话线或者 ISDN 拨号上网时，PPP 工作方式：

  1. 首先，用户向运营商的接入点拨打电话（图①-1），电话接通后（图①-2）输入用户名和密码进行登录操作（图②-2）

  2. 用户名和密码通过 RADIUS 协议从 RAS 证服务器，认证服务器校验这些信息是否正确

     - RADIUS：Remote Authentication Dial-in User Service，远程认证拨号用户服务

     - RAS：Remote Access Server，远程访问服务器

  3. 当确认无误后，认证服务器会返回 IP 地址等配置信息，并将这些信息下发给用户（图②-3）

  4. 用户的计算机根据这些信息配置 IP 地址等参数，完成 TCP/IP 收发网络包的准备工作，接下来就可以发送 TCP/IP 包了（图③）

- PPP 拨号链接过程重点在于图②-3 下发 TCP/IP 配置信息的步骤。在接入互联网时，必须为计算机分配一个公有地址，但这个地址并不是事先确定的。因为在拨号连接时，可以根据电话号码来改变接入点，而不同的接入点具有不同的 IP 地址，因此无法事先在计算机上设置这个地址。所以，在连接时运营商会向计算机下发 TCP/IP 配置信息，其中就包括为计算机分配的公有地址

#### 4.3.3 传输 PPP 消息

- 传输 PPP 消息的思路和将 IP 包装入以太网包中传输是一样的

  但是 PPP 协议中没有定义以太网中的报头和 FCS 等元素，也没有定义信号的格式，也就是说实际上 PPP 头部“缺少”了部分信息，因此无法直接将 PPP 消息转换成信号来发送。要传输 PPP 消息，必须有另一个包含报头、FCS、信号格式等元素的“容器”，然后将 PPP 消息装在这个容器里才行

  在拨号接入中 PPP 借用了 HDLC 协议作为容器，而 HDLC 协议原本是为在专线中传输网络包而设计的，拨号接入方式对这一规格进行了一些修正

  - HDLC：High-Level Data Link Control，高级数据联接控制

- ADSL 和 FTTH 接入方式也需要为计算机分配公有地址才能上网，这一点和拨号上网是相同的。不过，ADSL 和 FTTH 中，用户和 BAS 之间是通过电缆或光纤固定连接在一起的，因此没有必要验证用户身份，所以实际上并不需要 PPP 的所有这些功能。然而，通过用户名和密码登录的步骤可以根据用户名来切换不同的运营商，这很方便。因此，接入运营商在 ADSL 和 FTTH 中一般也会使用 PPP。不过，拨号上网的 PPP 是无法直接用于 ADSL 和 FTTH 的

  - 有些运营商用的是 DHCP 而不是 PPP 向客户端下发 IP 地址等配置信息

- 理论上 ADSL 和 FTTH 可以直接借用 HDLC 作为容器，这样 PPP 协议就可以直接使用了，但是 ADSL 和 FTTH 选用了另外一个机制作为代替。ADSL 和 FTTH 使用以太网包代替 HDLC 来装载 PPP 协议，此外，以太网和 PPP 在设计上有所不同，为了弥补这些问题就重新设计了一个新的规格，这就是 PPPoE

- 简单来说，PPPoE 是将 PPP 消息装入以太网包进行传输的方式

- 几种将 PPP 消息装载传输的方式：

  ![epub_907755_379.jpeg](/image/网络是怎样连接的/9c617275f617ce3f2e254782efc38de096857785.jpeg)

  ![epub_907755_380.jpeg](/image/网络是怎样连接的/9c4d290569dbd89df8fcecebb5a60f4aa75a8bb5.jpeg)

#### 4.3.4 隧道

- BAS 除了作为用户认证的窗口之外，还可以使用隧道方式来传输网络包

- 所谓隧道，就类似于套接字之间建立的 TCP 连接，也就是说，我们将包含头部在内的整个包从隧道的一头扔进去，这个包就会原封不动地从隧道的另一头出来，就好像在网络中挖了一条地道，网络包从这个地道里穿过去一样

- 在 BAS 和运营商路由器之间的 ADSL/FTTH 接入服务商的网络中建立一条隧道，将用户到 BAS 的接入网连接起来，就形成了一条从用户一直到运营商路由器的通道，网络包通过这条通道，就可以进入互联网内部了，这样的机制就类似于将接入网一直延伸到运营商路由器

- 无论任何机制，只要能够将包原封不动搬运到另一端，从原理上看就都可以用来建立隧道

- 隧道有几种实现方式：

  - TCP 方式。这种方式中，首先需要在网络上的两台隧道路由器（只要具备隧道功能，是不是路由器无所谓，有时也会使用服务器来建立隧道）之间建立 TCP 连接，然后将连接两端的套接字当作是路由器的端口，并从这个端口来收发数据。换句话说，在路由器收发包时，是基于隧道的规则向隧道中放入或取出网络包，这时，TCP 连接就好像变成了一根网线，包从这里穿过到达另一端

  - 基于封装（encapsulation）的隧道实现方式。这种方式是将包含头部在内的整个包装入另一个包中传输到隧道的另一端。在这种方式中，包本身可以原封不动地到达另一端的出口，从结果上看和基于 TCP 连接的方式是一样的，都实现了一个可供包进行穿梭的通道

- 隧道实现方式图解：

  ![epub_907755_382.jpeg](/image/网络是怎样连接的/79a566d30fa285bcdbe0153b4a34364f77b3134e.jpeg)

#### 4.3.5 接入网的整体工作过程

- 接入网的工作从用户端的互联网接入路由器进行连接操作开始，整体工作步骤：

  1. 首先，接入路由器中需要配置运营商分配的用户名和密码

     - 如果不使用路由器而是从计算机直接上网的情况下，需要在计算机中配置用户名和密码，这时计算机会代替路由器完成 PPPoE 操作，实际上这才是最初的原始方式。

  2. 然后，互联网接入路由器会根据 PPPoE 的发现机制来查询 BAS 的 MAC 地址。这一机制和 ARP 一样是基于广播来实现的。用户端就知道 BAS 的 MAC 地址后，也就可以和 BAS 进行通信了。可以认为前面这个过程相当于拨号上网中拨通电话的动作

  3. 接下来，就进入了上面部分所介绍的用户认证和下发配置的阶段，这里的工作工作比较复杂，注重下一部分所介绍的几个重点就好

  4. 接下来，客户端就会开始发送用来访问互联网的网络包

     - 这些包的目的地是互联网中的某个地方，这个地方或许在互联网接入路由器的路由表里是找不到的。这时，路由器会选择默认路由，并将这个包转发给默认路由的网关地址，也就是 BAS 下发的默认路由

     - 这里的操作过程和第 3 章介绍的路由器转发包的过程相同，只不过在通过路由表判断转发目标之后，包不是按照以太网规则转发，而是按照 PPPoE 规则转发，具体详细过程查看下一部分

  5. 接下来，网络包会到达 BAS，而 BAS 会将 MAC 头部和 PPPoE 头部去掉，取出 PPP 头部以及后面的部分，然后通过隧道机制将包发送出去

  6. 最后，PPP 包会沿隧道到达另一端的出口，也就是网络运营商的路由器

- 关于用户认证和下发配置的几个重点：

  - 第一个重点是用户名和密码如何发送给 BAS，这里有两种方式，在互联网接入路由器的设置画面中可以选择

    - 一种是将密码进行加密的 CHAP 方式。CHAP：Challenge Handshake Authentication Protocol，挑战握手认证协议

    - 另一种是不加密的 PAP 方式。PAP：Password Authentication Protocol，密码验证协议

    进行加密的 CHAP 方式显然安全性更高，一般也推荐使用这种方式，但也并不是说使用不加密的 PAP 方式密码就立刻会被窃取。由于明文密码只在 BAS 和用户端路由器之间传输，所以如果要窃取密码，要么在路由器和 ADSL Modem 中间进行窃听，要么爬到电线杆上安装窃听装置拾取电缆中泄漏的电磁波。不过，光纤是不会泄漏电磁波的，因此无法通过第二种方式进行窃听

    从 BAS 向认证服务器发送密码时使用 RADIUS 协议，无论用户拨入使用 CHAP 还是 PAP, RADIUS 都是加密的

  - 第二个重点是，在校验密码之后 BAS 如何向用户下发 TCP/IP 配置信息，一般是使用 PPP 或者 DHCP 的方式。这里下发的配置信息包括分配给上网设备的 IP 地址、DNS 服务器的 IP 地址以及默认网关的 IP 地址

    当使用路由器连接互联网时，路由器会根据这些信息配置自身的参数。这样一来，路由器的 BAS 端的端口就有了公有地址，路由表中也配置好了默认网关，接下来就可以将包转发到互联网中了

- 按照 PPPoE 规则转发包的具体过程流程图：

  ![epub_907755_391.jpeg](/image/网络是怎样连接的/a1069e4e8edcf23f43a3d1dcabc37320888d0abb.jpeg)

- 按照 PPPoE 规则转发包的具体过程流程步骤：

  1. 首先，要发送的包会被加上头部信息，并设置相应的字段

     - 第一个 MAC 头部中，接收方 MAC 地址填写通过 PPPoE 发现机制查询到的 BAS 的 MAC 地址，发送方 MAC 地址填写互联网接入路由器的 BAS 端的端口的 MAC 地址，然后以太类型填写代表 PPPoE 的 8864（十六进制）

     - 接下来是 PPPoE 头部和 PPP 头部，它们包含的字段如上图所示，其中除了载荷长度之外，其他的值都是可以事先确定的，载荷长度就是需要传输的包的长度

     - 再往后的部分就是包含 IP 头部在内的原始网络包

     - 可以说，这里的转发操作中基本上不需要根据头部中的信息进行判断，只要将事先准备好的头部加上去就可以了

  2. 然后，网络包会被转换成信号，从相应的端口发送出去

#### 4.3.6 不分配 IP 端口的无编号端口

- 前面介绍了 PPPoE 的工作过程，这里面有一个有趣的问题，就是互联网接入路由器在发送包的时候为什么要加上那些头部呢？

  头部里面的值基本上都是事先定好的，跟路由表里面的默认网关地址根本没什么关系。当采用一对一连接，也就是两台路由器的端口用一根线直接连起来的情况下，一端发送的包肯定会到达另一端，那么这种情况下就没有必要按照路由表查询默认网关来判断转发目标地址了。如果没有必要判断转发地址，那么网关的地址也就没什么用了；如果网关地址没用，那么目标路由器的端口也用不着分配 IP 地址了

  上面的性质对于所有一对一连接都是适用的。PPPoE 是工作在以太网上的协议，可以通过集线器与路由器和 BAS 连接，因此从物理层面的连接形态来看并不是一对一的。不过，通过发现机制开始和 BAS 通信后，逻辑层面上就是一对一通信，因此这一性质也是适用的。

- 以前在一对一的场景下，还是会为每个端口分配 IP 地址，这是因为有一条规则规定所有的端口都必须具有 IP 地址。然而，当公有地址越来越少时，就提出了一个特例，即一对一连接的端口可以不分配 IP 地址。现在，在这种场景中按惯例都是不为端口分配 IP 地址的，这种方式称为无编号（unnumbered）。这种情况下，BAS 下发配置信息时就不会下发默认网关的 IP 地址

#### 4.3.7 除 PPPoE 之外的其他方式

- PPPoA 是另外一种用于 ADSL 接入网的技术，PPPoA 不能使用在 FTTH 上，因为 FTTH 没有信元

- PPPoA：Point-to-Point Protocol over ATM，PPPoA 方式不添加 MAC 头部和 PPPoE 头部，而是直接将包装入信元中

- ADSL 使用 PPPoE 方式时，是先将 PPP 消息装入以太网包中，然后再将以太网包拆分并装入信元，而 PPPoA 方式是直接将 PPP 消息装入信元。由于只是开头加不加 MAC 头部和 PPPoE 头部的区别，PPP 消息本身是没有区别的，因此密码校验、下发 TCP/IP 配置参数、收发数据包等过程都是和 PPPoE 基本相同的

- PPPoA 工作流程图：

  ![epub_907755_400.jpeg](/image/网络是怎样连接的/12a475a8cf72c8efb8bcdc070bb3fff46c627e0c.jpeg)

- 由于 PPPoA 没有 MAC 头部，所以 PPP 消息是无法通过以太网来传输的，这就意味着需要和 BAS 收发 PPP 消息的设备，也就是计算机和路由器，必须和 ADSL Modem 是一体的，否则 PPP 机制就无法工作了。这个一体化的方式主要有以下两种：

  - 第一种是将计算机和 ADSL Modem 用 USB 接口连接起来，这样 ADSL Modem 就和计算机成为一体了。不过，这种方式最终并没有普及

  - 另一种方式是将 ADSL Modem 和路由器整合成一台设备。这种方式和 PPPoE 中使用路由器上网的方式基本没什么区别，因此得到了广泛的普及。不过，正如我们刚才提到的，当由于地址转换产生问题时，这种方式就不容易处理了，因为我们无法抛开路由器用计算机直接上网

- PPPoA 和 PPPoE 相比也有一些优势。PPPoE 方式中需要添加 PPPoE 头部和 PPP 头部，这意味着 MTU 就相应变小了，PPPoE 一般还会和隧道技术一起使用，这时还需要加上隧道头部，MTU 就更短了，这可能会降低网络的效率。而 PPPoA 不使用以太网包来传输 PPP 消息，因此不会发生 MTU 变小的问题

- PPPoE 会降低网络效率，PPPoA 也有 ADSL Modem 和路由器无法分离的限制，这两个问题其实都是由 PPP 引起的。因此，有一些运营商不使用 PPP，他们使用 DHCP 协议从 BAS 向用户端下发 TCP/IP 配置信息

  - DHCP：Dynamic Host Configuration Protocol，动态主机配置协议。

- DHCP 经常用于通过公司网络向客户端计算机下发 TCP/IP 配置信息，其原理如下图：

  ![epub_907755_403.jpeg](/image/网络是怎样连接的/676594bf11aec0b0c2f9c58e42d9db465d55615a.jpeg)

- DHCP 工作简略流程：

  1. 首先客户端请求配置信息（图①）

  2. 然后 DHCP 服务器下发配置信息（图②），非常简单，不需要像 PPP 那样需要多个步骤，也不需要验证用户名和密码

- DHCP 没有用户名和密码，就意味着无法通过用户名来切换运营商网络，但这种方式也有优势，它可以单纯地直接传输以太网包，不需要添加额外的 PPP 头部，因此不会占用 MTU

- 此外，采用 DHCP 的运营商使用的 ADSL Modem 也和 PPPoE、PPPoA 方式不同，这种 ADSL Modem 不使用信元，而是直接将以太网包调制成 ADSL 信号，因此没有 ADSL Modem 和路由器无法分离的问题。使用信元的 PPPoE 和 PPPoA 方式中，BAS 需要配备比较昂贵的 ATM 接口，因此不使用信元还可以控制成本。

### 4.4 网络运营商内部

#### 4.4.1 POP 和 NOC

- 互联网的实体并不是由一个组织运营管理的单一网络，而是由多个运营商网络相互连接组成的

- ADSL、FTTH 等接入网是与用户签约的运营商设备（也就是运营商的路由器）相连的，这些设备称为 POP，互联网的入口就位于这里

  - POP：Point of Presense，中文一般叫做“接入点”

- 互联网内部结构概览：

  ![epub_907755_407.jpeg](/image/网络是怎样连接的/057b327422a9026ea47803107cc51bc9bcda0eec.jpeg)

- POP 的结构根据接入网类型以及运营商的业务类型不同而不同，大体上如下图所示

  ![epub_907755_408.jpeg](/image/网络是怎样连接的/483f8322bc8ed6a4993cd415a5bce1d109955e1e.jpeg)

- POP 中包括各种类型的路由器，路由器的基本工作方式是相同的，但根据其角色分成了不同的类型，如上图所示：

  - 首先是专线，这里用的路由器就是具有通信线路端口的一般路由器。专线是固定连接线路，不需要进行身份认证，参数是根据传真、书面等方式下发后进行手动配置的，因此也不需要 PPP、DHCP 等机制，这就是最古老的互联网接入方式。专线不需要用户认证、配置下发等功能，因此用一般的路由器就可以了

  - 接下来是电话、ISDN 等拨号方式的接入网，这里使用的路由器称为 RAS。拨号接入需要对用户拨电话的动作进行应答，而 RAS 就具备这样的功能。此外，之前我们讲过通过 PPP 协议进行身份认证和配置下发的过程，RAS 也具备这些功能

  - 再往下是 PPPoE 方式的 ADSL 和 FTTH。PPPoE 方式中，ADSL、FTTH 接入服务商会使用 BAS，运营商的路由器则与 BAS 相连。PPPoE 中的身份认证和配置下发操作由接入服务商的 BAS 来负责，运营商的路由器只负责对包进行转发，因此这里也是使用一般的路由器就可以了

  - 如果 ADSL 采用 PPPoA 方式接入，那么工作过程会有所不同，DSLAM 通过 ATM 交换机（ATM 交换机是转发 ATM 信元的设备，负责将 DSLAM 输出的信元转发到 BAS）与 ADSL 的运营商的 BAS 相连，然后再连接到运营商的路由器。用户端传输的信号先经过 ADSL Modem 拆分成 ATM 信元并进行调制，然后 DSLAM 将信号还原成信元，通过 ATM 交换机转发到 BAS，最后 BAS 将信元还原成网络包，再通过运营商的路由器转发到互联网内部

- 对于连接接入网的部分来说，由于要连接的线路数量很多，所以路由器需要配备大量的端口，但能传输的网络包数量相对比较少，这是因为接入网的速率比互联网核心网络要低。因此，端口多且价格便宜的路由器适用于这些场景。

  相对地，图中左侧的路由器用于连接运营商和核心 NOC 以及其他 POP，所有连接接入网的路由器发出的包都会集中到这里，使用的线路速率也比较高，因此这里需要配备转发性能和数据吞吐量高的路由器

- NOC 是运营商的核心设备，从 POP 传来的网络包都会集中到这里，并从这里被转发到离目的地更近的 POP，或者是转发到其他的运营商。这里需要配备高性能的路由器

  - NOC：Network Operation Center，网络运行中心

- NOC 和 POP 并没有非常严格的界定。NOC 里面也可以配备连接接入网的路由器，很多情况下是和 POP 共用的，可以简单地认为，NOC 就是规模扩大后的 POP

#### 4.4.2 室外通信线路的链接

- 公司的机房一般使用双绞线来连接设备，但运营商的网络中需要传输大量的包，已经超过了双绞线能容纳的极限，因此一般还是更多地使用光纤

- 大楼室内可以用线路直接连接，对于距离较远的 NOC 和 POP 来说，它们之间的连接方式可以分为几种：

  - 对于自己拥有光纤的运营商来说，可以选择最简单的方式，也就是用光纤将 NOC 和 POP 直接连接起来

  - 不拥有光纤的运营商则可以使用租借通信线路的方式将相距较远的 NOC 和 POP 连接起来

- 拥有光纤的公司一般都会提供光纤租用服务。以电话公司为例，电话公司会在其拥有的光纤中传输语音数据，但一条光纤并不是只能传输一条语音数据，光纤是可以复用的，一条语音数据只占其通信能力的一部分。换句话说，电话公司可以将自己的光纤的一部分通信能力租借给客户。对于客户来说，只要支付一定的费用就可以使用其中的通信能力了。对于电话公司来说，其拥有的光纤不会全部自己使用，通过租借的方式也可以带来一定的收益，无论其业务本质是电话还是互联网，这一点都是共通的。这种服务就叫作通信线路服务

### 4.5 跨越运营商的网络包

#### 4.5.1 运营商之间的链接

- 到达 POP 路由器之后，网络包是如何前往下一站的：

  - 首先，如果最终目的地 Web 服务器和客户端是连接在同一个运营商中的，那么 POP 路由器的路由表中应该有相应的转发目标

    运营商的路由器可以和其他路由器交换路由信息，从而自动更新自己的路由表，通过这一功能，路由信息就实现了自动化管理

    于是，路由器根据路由表中的信息判断转发目标，这个转发目标可能是 NOC，也可能是相邻的 POP，无论如何，路由器都会把包转发出去，然后下一个路由器也同样根据自己路由表中的信息继续转发。经过几次转发之后，网络包就到达了 Web 服务器所在的 POP 的路由器，然后从这里被继续转发到 Web 服务器

  - 服务器的运营商和客户端的运营商不同情况下，网络包需要先发到服务器所在的运营商，这些信息也可以在路由表中找到，这是因为运营商的路由器和其他运营商的路由器也在交换路由信息，然后网络包会被转发到对方运营商的路由器。关于信息交换的具体过程查看下一部分

- 总之，对于互联网内部的路由器来说，无论最终目的地是否属于同一家运营商，都可以从路由表中查到，因此只要一次接一次按照路由表中的目标地址来转发包，最终一定可以到达 Web 服务器所在的 POP

#### 4.5.2 运营商之间的路由信息交换

- 运营商的路由信息使用 BGP 机制进行交换：

  - BGP：Border Gateway Protocol，边界网关协议

  - 简单来说就是从其他路由获取对方的所有路由信息，然后将自身的路由信息告诉对方

- 根据所告知的路由信息的内容，这种路由交换可分为两类：

  - 一类是将互联网中的路由全部告知对方

  - 另一种类型是两个运营商之间仅将与各自网络相关的路由信息告知对方

- 路由信息交换类型示意图：

  ![epub_907755_420.jpeg](/image/网络是怎样连接的/e4e8dda19614b2638f576e800668f56eb57384c7.jpeg)

  - 如果运营商 D 将互联网上所有路由都告知运营商 E，则运营商 E 不但可以访问运营商 D，还可以访问运营商 D 后面的运营商 B、A 和 C。然后，通过运营商 D 就可以向所有的运营商发送包。像这样，通过运营商 D 来发送网络包的方式称为转接

  - 如果两个运营商之间仅将与各自网络相关的路由信息告知对方，这样，只有双方之间的网络可以互相收发网络包，这种方式称为非转接，也叫对等

  - 对等的英文是 peer，BGP 规格中将互相交换路由信息的节点都称为 peer，但 BGP 的 peer 实际上包含了转接和非转接两种节点，但“对等”的 peer 仅包括非转接的节点，它们的意思不同，请不要混淆

#### 4.5.3 与公司网络中自动更新路由表机制的区别

- 公司中使用的方式是寻找与目的地之间的最短路由，并按照最短路由来转发包，因此，周围的所有路由器都是平等对待的

- 运营商使用最短路由的话，可能会导致其他运营商都走自己的”最短路由“。

  假设某个运营商拥有一条连接日本和美国的高速线路，那么要访问美国的地址时，可能这条线路是最短路由。如果单纯采用最短路由的方式，那么其他运营商的包就都会走这条线路，这时，该运营商需要向其他运营商收取相应的费用，否则就成义务劳动了。在这种情况下，如果使用最短路由的方式，就无法区分哪个运营商交了费，哪个运营商没交费，也就是说无法阻止那些没交费的运营商使用这条线路，这样就很难和对方进行交涉了

- 处于上述原因，互联网中不能单纯采用最短路由，而是需要一种能够阻止某些来源的网络包的机制，互联网的路由交换机制就具有这样的功能

  - 首先，互联网中可以指定路由交换的对象。公司中，路由信息是在所有路由器间平等交换的，但运营商之间的路由交换是在特定路由器间一对一进行的。这样一来，运营商就可以只将路由信息提供给那些交了费的运营商，那些没交费的运营商也就无法将网络包发送过来了

  - 其次，在判断路由时，该机制不仅可以判断是否是最短路由，还可以设置其他一些判断因素。例如当某个目的地有多条路由时，可以对每条路由设置优先级

- 互联网中有很多运营商，每个运营商都和其他多个运营商相互连接。因此，如果一个运营商走不过去，可以走另一个运营商，无论网络包要发送到什么地方，都会确保能够获取相应的路由信息

#### 4.5.4 IX

- IX：Internet eXchange，中文一般叫作“互联网交换中心”

- 如果每两个运营商都用通信线路一对一连接起来，会导致成本和建设的困难，因此需要设置一个中心设备，通过连接到中心设备的方式来减少线路数量，这个中心设备就称为 IX

- 由于 IX 比较重要，所以为了保证在遇到停电、火灾等事故，以及地震等自然灾害时，路由器等网络设备还能继续工作，IX 所在的大楼都装有自主发电设备，并具有一定的抗震能力。NOC 对安全的要求也是一样

- IX 的核心是具有大量高速以太网端口的二层交换机。二层交换机的基本原理和一般交换机相同，大家可以认为 IX 的核心就是大型的、高速的交换机

- 运营商链接 IX 核心交换机的方法：

  - 首先，当运营商 NOC 和 IX 位于同一幢大楼里时，只要从 NOC 中将光纤延长出来接到 IX 交换机就可以了。这种情况和公司、家庭网络中的路由器与交换机的连接方法是相同的

  - 如果 NOC 和 IX 不在同一幢大楼里，可以用通信线路将路由器和交换机连起来。这种情况下有两种连法，一种是从路由器延伸出一根通信线路并连接到 IX 交换机上，另一种是将路由器搬到 IX 机房里，用通信线路将路由器和 NOC 连起来，再将路由器连到 IX 交换机上

- 以前 IX 交换机都是放在一个地方的，也就是呈点状分布的。现在这些点状设施已经逐步扩张，在数据中心等网络流量集中的地方一般都会设置 IX 终端交换机，各运营商的路由器在这里连接到终端交换机上

- 运营商之间可以直接连接，也可以通过 IX 连接，无论是哪种方式，最终网络包都会到达服务器所在的运营商，然后通过 POP 进入服务器端的网络

- IX 链接简略图：

  ![epub_907755_430.jpeg](/image/网络是怎样连接的/797d8e6a74785cc8942c695875449fe3b2a7705b.jpeg)

